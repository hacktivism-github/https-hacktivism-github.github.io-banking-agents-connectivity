<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Mobile Operator's Coverage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- CSV helper -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position: absolute; right: 10px; top: 10px; z-index: 1000;
      background: #fff; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15); font: 13px/1.35 system-ui, sans-serif;
      width: 340px; max-width: calc(100vw - 20px);
    }
    .panel h3 { margin: 0 0 6px; font-size: 14px; }
    .row { margin: 6px 0; display: flex; align-items: center; gap: 8px; }
    .row label { white-space: nowrap; }
    .legend {
      position: absolute; left: 10px; bottom: 10px; z-index: 800;
      background: rgba(255,255,255,.9); padding: 8px 10px; border-radius: 6px;
      font: 12px system-ui, sans-serif;
    }
    .sw { display:inline-block; width:12px; height:12px; border-radius:2px; margin-right:6px; vertical-align:-2px; }
    .sw.unitel { background:#6c3fd6; }
    .sw.africell { background:#d94b4b; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; background:#f6f6f6; cursor:pointer; }

    .drop-hint {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,.65); color:#fff; padding:8px 12px; border-radius:6px; display:none;
      pointer-events:none; z-index:1200; font:13px system-ui,sans-serif;
    }
    .status-dot {
      width:9px; height:9px; border-radius:50%; display:inline-block; margin-left:6px;
      background:#bbb; border:1px solid #888;
    }
    .ok { background:#1bb34f !important; border-color:#10883b !important; }
    .err { background:#e04848 !important; border-color:#b93333 !important; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="drop-hint" id="dropHint">Largue um CSV (agentes) aqui…</div>

  <div class="panel">
    <h3>Camadas & Dados</h3>

    <div class="row">
      <label><input type="checkbox" id="chkUnitel"> Unitel 4G (nPerf)</label>
      <span id="dotUnitel" class="status-dot" title="estado da camada"></span>
      <label style="margin-left:12px;"><input type="checkbox" id="chkAfricell"> Africell 4G (nPerf)</label>
      <span id="dotAfricell" class="status-dot" title="estado da camada"></span>
    </div>

    <div class="row">
      <label style="min-width:80px;">Opacidade</label>
      <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.6" style="flex:1;">
      <button id="btnRefresh" class="btn" title="Forçar refresh dos tiles">↻</button>
    </div>

    <hr>

    <div class="row"><strong>CSV de agentes</strong></div>
    <div class="row">
      <input type="file" id="csvFile" accept=".csv" />
      <button class="btn" id="clearPoints">Limpar pontos</button>
    </div>
    <div style="color:#666; font-size:12px; margin-top:-2px;">
      Espera colunas como <em>latitude/longitude/nome</em> (auto-detecção: <em>lat, lon, name, displayName</em> etc.).
    </div>
  </div>

  <div class="legend">
    <div><span class="sw unitel"></span>Unitel 4G (nPerf)</div>
    <div><span class="sw africell"></span>Africell 4G (nPerf)</div>
    <div style="margin-top:6px;color:#666;">• Pode arrastar CSV para o mapa</div>
  </div>

  <script>
    // --- Base Map ---
    const map = L.map('map', { zoomControl: true }).setView([-11.5, 17], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // nPerf tile URLs (pre-filled; GH Pages safe)
    const URLS = {
      unitel:   "https://app.nperf.com/signal-220836-{z}-{x}-{y}.webp",
      africell: "https://app.nperf.com/signal-2019555-{z}-{x}-{y}.webp"
    };

    // Helper to build a monitored nPerf layer
    function makeNperfLayer(url, nameForLogs, statusDotEl, opacity) {
      // cache-buster support (set by the refresh button)
      const u = () => url + (makeNperfLayer._cacheBust ? `?t=${makeNperfLayer._cacheBust}` : "");

      const layer = L.tileLayer(u(), {
        opacity: opacity,
        crossOrigin: 'anonymous',     // helps with CORS / transparent tiles in some browsers
        tileSize: 256,
        updateWhenIdle: true
      });

      let loaded = 0, errors = 0;

      layer.on('tileload', (e) => {
        loaded++;
        statusDotEl.classList.remove('err');
        statusDotEl.classList.add('ok');
        if (loaded === 1) {
          console.log(`[nPerf:${nameForLogs}] primeiro tile carregado:`, e.tile.src);
        }
      });

      layer.on('tileerror', (e) => {
        errors++;
        statusDotEl.classList.remove('ok');
        statusDotEl.classList.add('err');
        console.warn(`[nPerf:${nameForLogs}] erro no tile:`, e.tile?.src || '(desconhecido)');
      });

      // expose a reload method for the ↻ button
      layer._reload = () => {
        statusDotEl.classList.remove('ok', 'err');
        layer.setUrl(u());   // Leaflet will refresh all visible tiles
        console.log(`[nPerf:${nameForLogs}] refresh solicitado.`);
      };

      return layer;
    }

    const opacityCtrl = document.getElementById('opacity');
    const dotUnitel   = document.getElementById('dotUnitel');
    const dotAfricell = document.getElementById('dotAfricell');

    const initialOpacity = parseFloat(opacityCtrl.value);
    const unitelLayer   = makeNperfLayer(URLS.unitel,   'Unitel',   dotUnitel,   initialOpacity);
    const africellLayer = makeNperfLayer(URLS.africell, 'Africell', dotAfricell, initialOpacity);

    // UI toggles + shared opacity
    const chkUnitel   = document.getElementById('chkUnitel');
    const chkAfricell = document.getElementById('chkAfricell');

    chkUnitel.addEventListener('change', e => {
      dotUnitel.classList.remove('ok','err'); // reset indicator
      if (e.target.checked) map.addLayer(unitelLayer);
      else {
        map.removeLayer(unitelLayer);
        dotUnitel.classList.remove('ok','err');
      }
    });

    chkAfricell.addEventListener('change', e => {
      dotAfricell.classList.remove('ok','err'); // reset indicator
      if (e.target.checked) map.addLayer(africellLayer);
      else {
        map.removeLayer(africellLayer);
        dotAfricell.classList.remove('ok','err');
      }
    });

    opacityCtrl.addEventListener('input', e => {
      const v = parseFloat(e.target.value);
      unitelLayer.setOpacity(v);
      africellLayer.setOpacity(v);
    });

    // Hard refresh of tiles (cache-bust)
    document.getElementById('btnRefresh').addEventListener('click', () => {
      makeNperfLayer._cacheBust = Date.now();
      if (map.hasLayer(unitelLayer))   unitelLayer._reload();
      if (map.hasLayer(africellLayer)) africellLayer._reload();
    });

    // --- Clustered CSV points ---
    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
    map.addLayer(cluster);

    function pickColumn(columns, candidates) {
      const lc = columns.map(c => c.toLowerCase());
      for (const cand of candidates) {
        const i = lc.indexOf(cand.toLowerCase());
        if (i !== -1) return columns[i];
      }
      return null;
    }

    function addCsvPoints(rows) {
      cluster.clearLayers();
      let count = 0;

      const cols = Object.keys(rows[0] || {});
      const latCol  = pickColumn(cols, ['latitude','lat']);
      const lonCol  = pickColumn(cols, ['longitude','lon','lng']);
      const nameCol = pickColumn(cols, ['nome','name','displayName','displayname','title']);

      if (!latCol || !lonCol) { alert('Não encontrei colunas de latitude/longitude.'); return; }

      rows.forEach(r => {
        const lat = parseFloat(String(r[latCol]).replace(',', '.'));
        const lon = parseFloat(String(r[lonCol]).replace(',', '.'));
        if (Number.isFinite(lat) && Number.isFinite(lon)) {
          const title = nameCol ? String(r[nameCol]) : 'Agente';
          const m = L.marker([lat, lon]).bindPopup(`<b>${title}</b><br>${lat.toFixed(5)}, ${lon.toFixed(5)}`);
          cluster.addLayer(m);
          count++;
        }
      });

      if (count) map.fitBounds(cluster.getBounds().pad(0.2));
    }

    function loadCsvFile(file) {
      Papa.parse(file, {
        header: true, skipEmptyLines: true,
        complete: (res) => {
          const rows = res.data;
          if (!rows.length) return alert('CSV vazio.');
          addCsvPoints(rows);
        }
      });
    }

    document.getElementById('csvFile').addEventListener('change', e => {
      const f = e.target.files[0]; if (f) loadCsvFile(f);
    });

    document.getElementById('clearPoints').addEventListener('click', () => cluster.clearLayers());

    // --- Drag & Drop (CSV only) ---
    const dropHint = document.getElementById('dropHint');
    function showHint(show){ dropHint.style.display = show ? 'block' : 'none'; }
    window.addEventListener('dragover', e => { e.preventDefault(); showHint(true); });
    window.addEventListener('dragleave', e => { showHint(false); });
    window.addEventListener('drop', e => {
      e.preventDefault(); showHint(false);
      const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
      if (!f) return;
      const name = (f.name || '').toLowerCase();
      if (name.endsWith('.csv')) return loadCsvFile(f);
      alert('Formato não suportado aqui. Use CSV.');
    });

    // Dica: em local, sirva via HTTP para evitar bloqueios do browser:
    //   python3 -m http.server 8000
  </script>
</body>
</html>

