<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Mobile Operator's Coverage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- CSV helper -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- App CSS/JS -->
  <link rel="stylesheet" href="assets/css/coverage_viewer.css" />
  <script defer src="assets/js/coverage_viewer.js"></script>
</head>
<body>
  <div id="map"></div>
  <div class="drop-hint" id="dropHint">Largue um CSV (agentes) aqui…</div>

  <div class="panel">
    <h3>Camadas & Dados</h3>

    <div class="row">
      <label><input type="checkbox" id="chkUnitel"> Unitel 4G (nPerf)</label>
      <label><input type="checkbox" id="chkAfricell"> Africell 4G (nPerf)</label>
    </div>

    <div class="row">
      <label style="min-width:80px;">Opacidade</label>
      <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.6" style="flex:1;">
    </div>

    <hr>

    <div class="row"><strong>Energia (GeoJSON)</strong></div>
    <div class="row">
      <input type="file" id="energyGeojsonInput" accept=".geojson,.json" />
      <button class="btn" id="clearEnergy">Limpar</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="unknownAsUnstable"> Assumir “instável” quando sem status</label>
    </div>
    <div style="color:#666; font-size:12px; margin-top:-2px;">
      Espera polígonos com <code>properties.grid_status</code> = <em>stable | unstable | offgrid</em>.
    </div>

    <hr>

    <div class="row"><strong>Municípios (Admin)</strong></div>
    <div class="row">
      <input type="file" id="munGeojsonInput" accept=".geojson,.json" />
      <button class="btn" id="clearMun">Limpar</button>
    </div>
    <div class="row" style="gap:6px;flex-wrap:wrap">
      <button class="btn" id="exportMunTemplateBtn">Gerar CSV-template</button>
      <input type="file" id="munStatusCsvInput" accept=".csv" />
    </div>
    <div style="color:#666; font-size:12px; margin-top:-2px;">
      Template: <code>mun_key, municipio, provincia, grid_status</code> (valores: <em>stable/unstable/offgrid</em>).<br>
      Ao carregar o CSV de status, os municípios são coloridos e passam a ser usados na classificação A–D.
    </div>

    <hr>

    <div class="row"><strong>CSV de agentes</strong></div>
    <div class="row">
      <input type="file" id="csvFile" accept=".csv" />
      <button class="btn" id="clearPoints">Limpar pontos</button>
    </div>
    <div style="color:#666; font-size:12px; margin-top:-2px;">
      Auto-detecção: <em>latitude/longitude</em> e nome (ex.: <em>nome, display</em>). Colunas opcionais: <em>coverage_best, unitel_best, africell_best</em>.
    </div>

    <hr>

    <div class="row" style="gap:6px; flex-wrap:wrap">
      <button class="btn" id="classifyBtn">Classificar Zonas (A–D)</button>
      <button class="btn" id="exportCsvBtn">Exportar CSV</button>
      <button class="btn" id="exportGeojsonBtn">Exportar GeoJSON</button>
    </div>

    <div class="row">
      <label><input type="checkbox" id="toggleZones" checked> Ver cores da Zona (A–D)</label>
    </div>

    <div style="color:#666; font-size:12px;">
      Se não houver <code>coverage_best</code>, o sistema pode derivar do melhor de <code>unitel_best</code> e <code>africell_best</code>. Sem cobertura ⇒ <b>B*</b> (provisório).
    </div>
  </div>

  <!-- Barra estilo nPerf -->
  <div class="nperf-bar" id="nperfBar">
    <div class="badge" id="lastUpdate">Last update — Unitel: –, Africell: –</div>
    <div class="techs">
      <div class="tech"><span class="dot none"></span><span>Sem</span></div>
      <div class="tech"><span class="dot g2"></span><span>2G</span></div>
      <div class="tech"><span class="dot g3"></span><span>3G</span></div>
      <div class="tech"><span class="dot g4"></span><span>4G</span></div>
      <div class="tech"><span class="dot g5"></span><span>5G</span></div>
    </div>
  </div>

  <!-- Legendas -->
  <div class="legend">
    <div><span class="sw unitel"></span>Unitel 4G (nPerf)</div>
    <div><span class="sw africell"></span>Africell 4G (nPerf)</div>
    <div style="margin-top:6px;color:#666;">• Pode arrastar CSV para o mapa</div>
  </div>

  <div class="legend legend-zones">
    <div style="font-weight:700; margin-bottom:4px;">Círculos (classificação por zona)</div>
    <div><span class="dot-legend red"></span>🔴 Vermelho → <b>Zona C</b> (off-grid / sem cobertura útil)</div>
    <div><span class="dot-legend yellow"></span>🟡 Amarelo → <b>Zona B</b> (ou <b>B*</b> quando a cobertura não está confirmada no CSV)</div>
    <div><span class="dot-legend green"></span>🟢 (se aparecer) → <b>Zona A</b> (energia estável + 4G/5G)</div>
    <div><span class="dot-legend blue"></span>🔵 (se aparecer) → <b>Zona D</b> (comunitária/mesh)</div>

    <hr style="border:none;border-top:1px solid #e4e4e4;margin:8px 0;">
    <div style="font-weight:700; margin-bottom:4px;">Clusters</div>
    <div><span class="cluster-sample zone-a"></span>Cor do cluster = <b>zona predominante</b> dentro do grupo (A/B/C/D).</div>
  </div>
</body>
</html>
