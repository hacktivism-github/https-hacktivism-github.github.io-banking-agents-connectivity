<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RNT → OSM Digitizer (with Warp)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- Distortable image plugin for interactive georeferencing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.distortableimage@0.12.0/dist/leaflet.distortableimage.css" />
  <script src="https://unpkg.com/leaflet.distortableimage@0.12.0/dist/leaflet.distortableimage.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel {
      position: absolute; right: 10px; top: 10px; z-index: 1000;
      background: #fff; padding: 12px; border-radius: 10px; width: 420px;
      box-shadow: 0 8px 30px rgba(2,8,20,.15); font: 13px/1.35 system-ui, sans-serif;
      max-height: calc(100vh - 20px); overflow: auto;
    }
    .panel h3 { margin: 0 0 8px; font-size: 16px; }
    .panel h4 { margin: 14px 0 6px; font-size: 13px; opacity: .85; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; margin: 6px 0; }
    .row > label { grid-column: 1 / span 2; font-weight: 600; opacity: .85; }
    .row > input[type="text"], .row > input[type="number"], .row > select, .row > textarea {
      grid-column: 1 / span 2; padding: 8px 10px; border-radius: 8px; border: 1px solid #e4e7ec; outline: none;
    }
    .row .btn { padding: 8px 10px; border-radius: 8px; border: 1px solid #d0d5dd; cursor: pointer; background: #f8fafc; }
    .row .btn.primary { background: #0ea5e9; color: #fff; border-color: #0ea5e9; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border:1px solid #e5e7eb; }
    .legend {
      position: absolute; left: 10px; bottom: 10px; z-index: 1000; background: #fff;
      padding: 10px; border-radius: 10px; box-shadow: 0 8px 30px rgba(2,8,20,.15); font: 12px/1.35 system-ui, sans-serif;
    }
    .legend .item { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 4px; border: 1px solid #d0d5dd; }
    .hr { height: 1px; background: #eee; margin: 10px 0; }
    .nudge { display:flex; gap:6px; }
    .nudge button { width:34px; height:30px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>RNT → OSM Digitizer (with Warp)</h3>
    <div class="row"><label>1) OSM basemap is active. Overlay the RNT PNG and align it by corners.</label></div>
    <div class="row"><label>PNG file</label><input id="pngFile" type="file" accept="image/png,image/jpeg" /></div>
    <div class="row"><label>…or Image URL (HTTPS)</label><input id="imgUrl" type="text" placeholder="https://your-server/rnt.png" /><button class="btn" id="btnLoadUrl">Load</button></div>

    <div class="row"><label>Preset Angola bounds (rectangle start)</label></div>
    <div class="row"><button class="btn" id="btnPreset">Preset Angola</button> <button class="btn" id="btnApplyBounds">Apply / Fit</button></div>

    <div class="row"><label>NW (lat,lng)</label></div>
    <div class="row"><input id="nwLat" type="number" step="0.0001" value="-4.30"/><input id="nwLng" type="number" step="0.0001" value="11.60"/></div>
    <div class="row"><label>SE (lat,lng)</label></div>
    <div class="row"><input id="seLat" type="number" step="0.0001" value="-18.10"/><input id="seLng" type="number" step="0.0001" value="24.10"/></div>

    <div class="row"><label>Overlay controls</label></div>
    <div class="row"><button class="btn" id="btnEnableWarp" disabled>Enable Warp</button><button class="btn" id="btnDisableWarp" disabled>Lock</button><button class="btn" id="btnHideOverlay" disabled>Hide</button></div>
    <div class="row"><label>Opacity</label><input id="opacity" type="range" min="0.2" max="1" step="0.05" value="0.55"/></div>
    <div class="row"><label>Nudge (move 0.05°)</label></div>
    <div class="row nudge">
      <button id="nN">↑</button><button id="nS">↓</button><button id="nW">←</button><button id="nE">→</button>
    </div>

    <div class="hr"></div>
    <h4>2) Digitize features</h4>
    <div class="row"><button class="btn" id="btnAddSub">Add Substation</button><button class="btn" id="btnAddGen">Add Generation</button></div>
    <div class="row"><button class="btn" id="btnDrawLine">Draw Transmission Line</button><button class="btn" id="btnStopDraw">Stop</button></div>

    <div class="hr"></div>
    <h4>3) Data</h4>
    <div class="row"><button class="btn" id="btnExport">Export GeoJSON</button><button class="btn" id="btnClear">Clear</button></div>
    <div class="row"><label>Import GeoJSON</label><input id="geojsonFile" type="file" accept=".json,.geojson" /></div>

    <div class="hr"></div>
    <div class="row"><label>Zone thresholds (reliability)</label></div>
    <div class="row">A ≥ <input id="thrA" type="number" min="0" max="100" value="80" style="width:60px"> &nbsp; B ≥ <input id="thrB" type="number" min="0" max="100" value="50" style="width:60px"> &nbsp; C ≥ <input id="thrC" type="number" min="0" max="100" value="20" style="width:60px"></div>
  </div>

  <div class="legend">
    <div style="font-weight:600; margin-bottom:6px">Legend</div>
    <div class="item"><span class="swatch" style="background:#111827"></span> Transmission line</div>
    <div class="item"><span class="swatch" style="background:#16a34a"></span> Zone A site</div>
    <div class="item"><span class="swatch" style="background:#3b82f6"></span> Zone B site</div>
    <div class="item"><span class="swatch" style="background:#f59e0b"></span> Zone C site</div>
    <div class="item"><span class="swatch" style="background:#ef4444"></span> Zone D site</div>
  </div>

  <script>
    // --- Map with OSM base (EPSG:3857) ---
    const map = L.map('map', { zoomControl: true }).setView([-11.2, 17.8], 5); // Angola approx
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layers
    const overlayLayer = L.layerGroup().addTo(map); // image overlay holder
    const sitesLayer = L.layerGroup().addTo(map);
    const linesLayer = L.layerGroup().addTo(map);

    // Distortable overlay instance
    let dOverlay = null; // L.DistortableImageOverlay
    let lastSrc = null;

    // Helpers to read/write inputs
    const $ = (id)=>document.getElementById(id);
    function readBounds(){ return { nw:[+$('nwLat').value, +$('nwLng').value], se:[+$('seLat').value, +$('seLng').value] }; }
    function rectCornersFromBounds(nw,se){ return [nw, [nw[0], se[1]], se, [se[0], nw[1]]]; }

    // Create or update overlay
    function ensureOverlay(src, useCorners){
      lastSrc = src || lastSrc;
      if (!lastSrc) return;
      const b = readBounds();
      const corners = useCorners || rectCornersFromBounds(b.nw, b.se);
      if (dOverlay) { overlayLayer.removeLayer(dOverlay); dOverlay = null; }
      dOverlay = L.distortableImageOverlay(lastSrc, { corners, selected: true, suppressToolbar: true, editable: true, opacity: +$('opacity').value });
      dOverlay.addTo(overlayLayer);
      map.fitBounds([b.nw, b.se]);
      enableOverlayButtons(true);
    }

    function enableOverlayButtons(on){ ['btnEnableWarp','btnDisableWarp','btnHideOverlay'].forEach(id=>$(id).disabled=!on); }

    // Loaders
    $('pngFile').addEventListener('change', ev=>{ const f=ev.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ lastSrc=r.result; ensureOverlay(lastSrc); }; r.readAsDataURL(f); });
    $('btnLoadUrl').onclick = ()=>{ const u=$('imgUrl').value.trim(); if(u){ lastSrc=u; ensureOverlay(lastSrc); } };

    $('btnApplyBounds').onclick = ()=> ensureOverlay();
    $('btnPreset').onclick = ()=>{ $('nwLat').value=-4.30; $('nwLng').value=11.60; $('seLat').value=-18.10; $('seLng').value=24.10; };

    $('btnEnableWarp').onclick = ()=>{ if(dOverlay && dOverlay.editing) dOverlay.editing.enable(); };
    $('btnDisableWarp').onclick = ()=>{ if(dOverlay && dOverlay.editing) dOverlay.editing.disable(); };
    $('btnHideOverlay').onclick = ()=>{ if(dOverlay){ overlayLayer.removeLayer(dOverlay); dOverlay=null; enableOverlayButtons(false);} };

    $('opacity').addEventListener('input', ()=>{ if(dOverlay) dOverlay.setOpacity(+$('opacity').value); });

    // Nudge controls (move rectangle corners, not warped state)
    function nudge(dx, dy){
      const b=readBounds();
      b.nw=[b.nw[0]+dy, b.nw[1]+dx];
      b.se=[b.se[0]+dy, b.se[1]+dx];
      $('nwLat').value=b.nw[0].toFixed(4); $('nwLng').value=b.nw[1].toFixed(4);
      $('seLat').value=b.se[0].toFixed(4); $('seLng').value=b.se[1].toFixed(4);
      if(lastSrc) ensureOverlay();
    }
    $('nN').onclick=()=>nudge(0, +0.05);
    $('nS').onclick=()=>nudge(0, -0.05);
    $('nW').onclick=()=>nudge(-0.05, 0);
    $('nE').onclick=()=>nudge(+0.05, 0);

    // --- Digitizing ---
    let addMode = null; // 'sub' | 'gen'
    const ZCOL = { A:'#16a34a', B:'#3b82f6', C:'#f59e0b', D:'#ef4444' };
    const thrA = $('thrA'), thrB=$('thrB'), thrC=$('thrC');

    function classify(rec){
      const rel=+rec.reliability||0; const t=(rec.energy_type||'').toLowerCase();
      if ((t==='grid'||t==='mini-grid') && rel>=+thrA.value) return 'A';
      if ((t==='grid'||t==='mini-grid') && rel>=+thrB.value) return 'B';
      if (t==='generator'||t==='solar'||rel>=+thrC.value) return 'C';
      return 'D';
    }

    function siteIcon(color){ return L.divIcon({className:'', html:`<div style="width:14px;height:14px;border-radius:50%;border:2px solid #111;background:${color}"></div>`, iconSize:[18,18], iconAnchor:[9,9]}); }
    function popupHtml(rec){ const zone=classify(rec); return `<div style="min-width:220px"><div style="font-weight:700;margin-bottom:4px">${escapeHtml(rec.name||'Unnamed')}</div><div><span class="pill">Zone ${zone}</span> • <strong>${escapeHtml(rec.energy_type||'?')}</strong> • Reliability: <strong>${rec.reliability??'?'}%</strong></div>${rec.kv?`<div>Voltage: <strong>${rec.kv} kV</strong></div>`:''}${rec.hours_per_day?`<div>Hours/day: <strong>${rec.hours_per_day}</strong></div>`:''}${rec.status?`<div>Status: <strong>${escapeHtml(rec.status)}</strong></div>`:''}${rec.notes?`<div style="margin-top:4px;white-space:pre-wrap">${escapeHtml(rec.notes)}</div>`:''}<div class="hr"></div><button onclick="window.__editSite('${rec.__id}')">Edit</button><button style="margin-left:6px" onclick="window.__delSite('${rec.__id}')">Delete</button></div>`; }

    const SITES=[]; // {__id,lat,lng,name,type,energy_type,reliability,kv,hours_per_day,status,notes}
    function redrawSites(){ sitesLayer.clearLayers(); SITES.forEach(rec=>{ const zone=classify(rec); L.marker([rec.lat,rec.lng],{ icon:siteIcon(ZCOL[zone]) }).bindPopup(popupHtml(rec)).addTo(sitesLayer); }); }

    function openSiteEditor(rec){ const html=document.createElement('div'); html.innerHTML=`<div style="display:grid;grid-template-columns:1fr;gap:6px;width:260px"><label>Name<input id="f_name" value="${escapeAttr(rec.name||'')}"/></label><label>Type<select id="f_type"><option ${rec.type==='substation'?'selected':''}>substation</option><option ${rec.type==='generation'?'selected':''}>generation</option></select></label><label>Energy type<select id="f_et">${['grid','mini-grid','generator','solar','none'].map(v=>`<option ${rec.energy_type===v?'selected':''}>${v}</option>`).join('')}</select></label><label>Reliability (0–100)<input id="f_rel" type="number" min="0" max="100" value="${Number(rec.reliability||0)}"/></label><label>Voltage kV (optional)<input id="f_kv" type="number" step="1" value="${rec.kv||''}"/></label><label>Hours per day (optional)<input id="f_hpd" type="number" min="0" max="24" value="${rec.hours_per_day||''}"/></label><label>Status<input id="f_status" value="${escapeAttr(rec.status||'')}"/></label><label>Notes<textarea id="f_notes">${escapeHtml(rec.notes||'')}</textarea></label><div style="display:flex;gap:8px;margin-top:6px"><button id="save" class="btn primary">Save</button><button id="cancel" class="btn">Cancel</button></div></div>`; const pop=L.popup().setLatLng([rec.lat,rec.lng]).setContent(html).openOn(map); html.querySelector('#save').onclick=()=>{ rec.name=html.querySelector('#f_name').value.trim(); rec.type=html.querySelector('#f_type').value; rec.energy_type=html.querySelector('#f_et').value; rec.reliability=+html.querySelector('#f_rel').value; rec.kv=+html.querySelector('#f_kv').value||''; rec.hours_per_day=html.querySelector('#f_hpd').value; rec.status=html.querySelector('#f_status').value; rec.notes=html.querySelector('#f_notes').value; redrawSites(); map.closePopup(pop); }; html.querySelector('#cancel').onclick=()=>map.closePopup(pop); }

    window.__editSite = (id)=>{ const rec=SITES.find(s=>s.__id===id); if(rec) openSiteEditor(rec); };
    window.__delSite = (id)=>{ const i=SITES.findIndex(s=>s.__id===id); if(i>=0){ SITES.splice(i,1); redrawSites(); } };

    map.on('click', (e)=>{ if (!addMode) return; const t=addMode==='sub'?'substation':'generation'; const rec={ __id:crypto.randomUUID(), lat:e.latlng.lat, lng:e.latlng.lng, type:t, name:'', energy_type:t==='substation'?'grid':'generator', reliability:t==='substation'?80:50 }; SITES.push(rec); openSiteEditor(rec); });

    $('btnAddSub').onclick = ()=>{ addMode=addMode==='sub'?null:'sub'; toggleBtn('btnAddSub', addMode==='sub'); };
    $('btnAddGen').onclick = ()=>{ addMode=addMode==='gen'?null:'gen'; toggleBtn('btnAddGen', addMode==='gen'); };
    function toggleBtn(id,on){ $(id).classList.toggle('primary', on); }

    // --- Transmission lines drawing ---
    let currentDraw = null;
    const drawOptions = { polyline: { shapeOptions: { color:'#111827', weight:3, opacity:0.9 } }, polygon:false, rectangle:false, circle:false, circlemarker:false, marker:false };
    $('btnDrawLine').onclick = ()=>{ if (currentDraw) currentDraw.disable(); currentDraw = new L.Draw.Polyline(map, drawOptions.polyline); currentDraw.enable(); };
    $('btnStopDraw').onclick = ()=>{ if (currentDraw) currentDraw.disable(); currentDraw=null; };
    map.on(L.Draw.Event.CREATED, (e)=>{ if (e.layerType==='polyline'){ linesLayer.addLayer(e.layer); } });

    // --- Export / Import ---
    $('btnExport').onclick = ()=>{ const fc={ type:'FeatureCollection', features:[] }; SITES.forEach(s=>{ fc.features.push({ type:'Feature', geometry:{ type:'Point', coordinates:[s.lng,s.lat] }, properties:{ ...s, zone:classify(s) } }); }); linesLayer.eachLayer(l=>{ const coords=l.getLatLngs().map(ll=>[ll.lng,ll.lat]); fc.features.push({ type:'Feature', geometry:{ type:'LineString', coordinates:coords }, properties:{ kind:'transmission_line' } }); }); downloadText('rnt_osm_digitized.geojson', JSON.stringify(fc,null,2)); };
    $('geojsonFile').addEventListener('change', async (ev)=>{ const f=ev.target.files?.[0]; if(!f) return; const text=await f.text(); try{ const gj=JSON.parse(text); loadGeoJSON(gj); } catch(err){ alert('Invalid GeoJSON'); } });

    function loadGeoJSON(gj){ SITES.length=0; sitesLayer.clearLayers(); linesLayer.clearLayers(); (gj.features||[]).forEach(ft=>{ if(ft.geometry?.type==='Point'){ const [lng,lat]=ft.geometry.coordinates; const p=ft.properties||{}; SITES.push({ __id:crypto.randomUUID(), lat, lng, name:p.name||'', type:p.type||'substation', energy_type:p.energy_type||'grid', reliability:p.reliability||0, kv:p.kv||'', hours_per_day:p.hours_per_day||'', status:p.status||'', notes:p.notes||'' }); } else if(ft.geometry?.type==='LineString'){ const latlngs=(ft.geometry.coordinates||[]).map(([lng,lat])=>L.latLng(lat,lng)); L.polyline(latlngs, drawOptions.polyline.shapeOptions).addTo(linesLayer); } }); redrawSites(); }

    // Helpers
    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function escapeAttr(s){ return String(s).replace(/\"/g,'&quot;'); }
    function downloadText(filename, text){ const blob=new Blob([text],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),5000); }
  </script>
</body>
</html>
