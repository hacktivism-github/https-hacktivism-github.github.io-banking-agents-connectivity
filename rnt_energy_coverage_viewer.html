<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RNT → OSM Digitizer (Zones A–D) — Minimal</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel { position:absolute; right:10px; top:10px; z-index:1000; background:#fff; padding:12px; border-radius:10px; width:420px; box-shadow:0 8px 30px rgba(2,8,20,.15); font:13px/1.4 system-ui, sans-serif; max-height:calc(100vh - 20px); overflow:auto; }
    .panel h3 { margin:0 0 6px; font-size:16px; }
    .row { display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; margin:6px 0; }
    .row > label { grid-column:1 / span 2; font-weight:600; opacity:.85; }
    .row > input, .row > select, .row > textarea { grid-column:1 / span 2; padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; }
    .btn { padding:8px 10px; border-radius:8px; border:1px solid #d1d5db; background:#f8fafc; cursor:pointer; }
    .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .legend { position:absolute; left:10px; bottom:10px; z-index:1000; background:#fff; padding:10px; border-radius:10px; box-shadow:0 8px 30px rgba(2,8,20,.15); font:12px/1.35 system-ui, sans-serif; }
    .legend .item { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .swatch { width:14px; height:14px; border-radius:4px; border:1px solid #d0d5dd; }
    .hr { height:1px; background:#eee; margin:10px 0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; }
    .note { font-size:12px; opacity:.75; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>RNT → OSM Digitizer</h3>
    <div class="note">Digitize Angola's power infrastructure in real coordinates. Import/Export GeoJSON. Zones A–D auto‑computed from reliability.</div>

    <div class="hr"></div>
    <h4>Basemap</h4>
    <div class="row"><label>Select provider</label></div>
    <div class="row"><select id="basemapSel"><option value="ESRI" selected>Esri Streets</option><option value="OSM">OpenStreetMap</option><option value="CARTO">Carto Light</option></select><button class="btn" id="btnTestMarker">Test marker</button><button class="btn" id="btnFitAngola">Fit Angola</button></div>

    <div class="hr"></div>
    <h4>Add by Geolocation</h4>
    <div class="row"><label>Latitude / Longitude (decimal degrees)</label></div>
    <div class="row"><input id="geoLat" type="number" step="0.000001" placeholder="Lat e.g. -8.838" /><input id="geoLng" type="number" step="0.000001" placeholder="Lng e.g. 13.234" /></div>
    <div class="row"><input id="geoName" type="text" placeholder="Name (optional)" /><select id="geoType"><option value="substation" selected>substation</option><option value="generation">generation</option></select></div>
    <div class="row"><button class="btn" id="btnGeoAddSub">Add Substation (Lat/Lng)</button><button class="btn" id="btnGeoAddGen">Add Generation (Lat/Lng)</button></div>

    <div class="hr"></div>
    <h4>Digitize features</h4>
    <div class="row"><button class="btn" id="btnAddSub">Add Substation (click map)</button><button class="btn" id="btnAddGen">Add Generation (click map)</button></div>
    <div class="row"><button class="btn" id="btnDrawLine">Draw Transmission Line</button><button class="btn" id="btnStopDraw">Stop</button></div>

    <div class="hr"></div>
    <h4>Data</h4>
    <div class="row"><button class="btn" id="btnExport">Export GeoJSON</button><button class="btn" id="btnClear">Clear</button></div>
    <div class="row"><label>Import GeoJSON</label><input id="geojsonFile" type="file" accept=".json,.geojson" /></div>
    <div class="note">Importer accepts <code>type</code> or <code>kind</code> for feature type (<code>substation</code> | <code>generation</code> | <code>transmission_line</code>).</div>

    <div class="hr"></div>
    <h4>Zone thresholds (reliability)</h4>
    <div class="row">A ≥ <input id="thrA" type="number" min="0" max="100" value="80" style="width:60px"> &nbsp; B ≥ <input id="thrB" type="number" min="0" max="100" value="50" style="width:60px"> &nbsp; C ≥ <input id="thrC" type="number" min="0" max="100" value="20" style="width:60px"></div>
  </div>

  <div class="legend">
    <div style="font-weight:600; margin-bottom:6px">Legend</div>
    <div class="item"><span class="swatch" style="background:#111827"></span> Transmission line</div>
    <div class="item"><span class="swatch" style="background:#16a34a"></span> Zone A site</div>
    <div class="item"><span class="swatch" style="background:#3b82f6"></span> Zone B site</div>
    <div class="item"><span class="swatch" style="background:#f59e0b"></span> Zone C site</div>
    <div class="item"><span class="swatch" style="background:#ef4444"></span> Zone D site</div>
  </div>

  <script>
    // --- Map init ---
    const map = L.map('map', { zoomControl:true }).setView([-11.2, 17.8], 5);

    // Basemap providers + debug grid fallback
    const providers = {
      OSM:  { url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attrib:'&copy; OpenStreetMap contributors' },
      CARTO:{ url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', attrib:'&copy; OpenStreetMap & CARTO' },
      ESRI: { url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', attrib:'Tiles &copy; Esri' }
    };
    let baseLayer=null, tilesLoaded=0, gridLayer=null, gridOn=false;
    function setBasemap(key){
      const cfg = providers[key] || providers.ESRI;
      if (baseLayer) map.removeLayer(baseLayer);
      if (gridLayer) { map.removeLayer(gridLayer); gridLayer=null; gridOn=false; const n=document.getElementById('gridNotice'); if(n) n.remove(); }
      tilesLoaded=0;
      baseLayer = L.tileLayer(cfg.url, { maxZoom: 19, attribution: cfg.attrib, crossOrigin:true });
      baseLayer.on('tileload', ()=>{ tilesLoaded++; });
      baseLayer.addTo(map);
      setTimeout(()=>{ if(tilesLoaded===0) enableDebugGrid(); }, 2500);
    }
    function enableDebugGrid(){ if(gridOn) return; gridOn=true; gridLayer = L.gridLayer({ attribution:'Debug grid' }); gridLayer.createTile = function(c){ const t=document.createElement('canvas'); t.width=256; t.height=256; const x=t.getContext('2d'); x.fillStyle='#f3f4f6'; x.fillRect(0,0,256,256); x.strokeStyle='#d1d5db'; for(let i=0;i<256;i+=32){ x.beginPath(); x.moveTo(i,0); x.lineTo(i,256); x.stroke(); x.beginPath(); x.moveTo(0,i); x.lineTo(256,i); x.stroke(); } x.fillStyle='#111827'; x.font='12px system-ui'; x.fillText(`z:${c.z}`,8,20); x.fillText(`x:${c.x}`,8,40); x.fillText(`y:${c.y}`,8,60); return t; }; gridLayer.addTo(map); const note=document.createElement('div'); note.id='gridNotice'; note.style.cssText='position:absolute;left:10px;top:10px;z-index:1100;background:#fff;padding:6px 10px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.1);font:12px system-ui;'; note.textContent='Basemap tiles blocked → showing local debug grid.'; document.body.appendChild(note); }
    setBasemap('ESRI');
    setTimeout(()=>map.invalidateSize(), 120);

    // --- State & helpers ---
    const ZCOL = { A:'#16a34a', B:'#3b82f6', C:'#f59e0b', D:'#ef4444' };
    const thrA = document.getElementById('thrA');
    const thrB = document.getElementById('thrB');
    const thrC = document.getElementById('thrC');
    const SITES=[]; // records

    function classify(rec){ const rel=+rec.reliability||0; const t=(rec.energy_type||'').toLowerCase(); if((t==='grid'||t==='mini-grid')&&rel>=+thrA.value) return 'A'; if((t==='grid'||t==='mini-grid')&&rel>=+thrB.value) return 'B'; if(t==='generator'||t==='solar'||rel>=+thrC.value) return 'C'; return 'D'; }
    function siteIcon(color){ return L.divIcon({className:'', html:`<div style="width:14px;height:14px;border-radius:50%;border:2px solid #111;background:${color}"></div>`, iconSize:[18,18], iconAnchor:[9,9]}); }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
    function downloadText(filename, text){ const blob=new Blob([text],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 3500); }

    function popupHtml(rec){ const zone=classify(rec); return `<div style="min-width:260px"><div style="font-weight:700;margin-bottom:4px">${escapeHtml(rec.name||'Unnamed')}</div><div><span class=\"pill\">Zone ${zone}</span> • <strong>${escapeHtml(rec.type||'?')}</strong> • <em>${escapeHtml(rec.energy_type||'?')}</em></div>${rec.mw?`<div>Capacity: <strong>${rec.mw} MW</strong></div>`:''}${rec.kv?`<div>Voltage: <strong>${rec.kv} kV</strong></div>`:''}<div>Reliability: <strong>${rec.reliability??'?'}%</strong></div><div>Lat/Lng: <strong>${rec.lat.toFixed(6)}, ${rec.lng.toFixed(6)}</strong></div>${rec.status?`<div>Status: <strong>${escapeHtml(rec.status)}</strong></div>`:''}${rec.notes?`<div style=\"margin-top:4px;white-space:pre-wrap\">${escapeHtml(rec.notes)}</div>`:''}<div class=\"hr\"></div><button onclick=\"window.__editSite('${rec.__id}')\">Edit</button><button style=\"margin-left:6px\" onclick=\"window.__delSite('${rec.__id}')\">Delete</button></div>`; }

    function redrawSites(){ sitesLayer.clearLayers(); SITES.forEach(rec=>{ const m=L.marker([rec.lat,rec.lng],{ icon:siteIcon(ZCOL[classify(rec)]), draggable:true }); m.bindPopup(popupHtml(rec)); m.on('dragend',()=>{ const ll=m.getLatLng(); rec.lat=ll.lat; rec.lng=ll.lng; m.setIcon(siteIcon(ZCOL[classify(rec)])); m.setPopupContent(popupHtml(rec)); }); m.addTo(sitesLayer); }); }

    function openSiteEditor(rec){ const html=document.createElement('div'); html.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;width:300px"><label style="grid-column:1 / span 2">Name<input id="f_name" value="${escapeAttr(rec.name||'')}"/></label><label>Lat<input id="f_lat" type="number" step="0.000001" value="${Number(rec.lat).toFixed(6)}"/></label><label>Lng<input id="f_lng" type="number" step="0.000001" value="${Number(rec.lng).toFixed(6)}"/></label><label>Type<select id="f_type"><option ${rec.type==='substation'?'selected':''}>substation</option><option ${rec.type==='generation'?'selected':''}>generation</option></select></label><label>Energy<select id="f_et">${['grid','mini-grid','generator','solar','none'].map(v=>`<option ${rec.energy_type===v?'selected':''}>${v}</option>`).join('')}</select></label><label>Reliability<input id="f_rel" type="number" min="0" max="100" value="${Number(rec.reliability||0)}"/></label><label>Capacity MW<input id="f_mw" type="number" step="1" value="${rec.mw||''}"/></label><label>Voltage kV<input id="f_kv" type="number" step="1" value="${rec.kv||''}"/></label><label style="grid-column:1 / span 2">Status<input id="f_status" value="${escapeAttr(rec.status||'')}"/></label><label style="grid-column:1 / span 2">Notes<textarea id="f_notes">${escapeHtml(rec.notes||'')}</textarea></label><div style="grid-column:1 / span 2;display:flex;gap:8px;margin-top:6px"><button id="save" class="btn primary">Save</button><button id="cancel" class="btn">Cancel</button></div></div>`; const pop=L.popup().setLatLng([rec.lat,rec.lng]).setContent(html).openOn(map); html.querySelector('#save').onclick=()=>{ rec.name=html.querySelector('#f_name').value.trim(); rec.lat=Number(html.querySelector('#f_lat').value); rec.lng=Number(html.querySelector('#f_lng').value); rec.type=html.querySelector('#f_type').value; rec.energy_type=html.querySelector('#f_et').value; rec.reliability=+html.querySelector('#f_rel').value; rec.mw=+html.querySelector('#f_mw').value||''; rec.kv=+html.querySelector('#f_kv').value||''; rec.status=html.querySelector('#f_status').value; rec.notes=html.querySelector('#f_notes').value; redrawSites(); map.closePopup(pop); map.panTo([rec.lat,rec.lng]); }; html.querySelector('#cancel').onclick=()=>map.closePopup(pop); }

    window.__editSite = id=>{ const rec=SITES.find(s=>s.__id===id); if(rec) openSiteEditor(rec); };
    window.__delSite = id=>{ const i=SITES.findIndex(s=>s.__id===id); if(i>=0){ SITES.splice(i,1); redrawSites(); } };

    const sitesLayer=L.layerGroup().addTo(map);
    const linesLayer=L.layerGroup().addTo(map);

    // Add modes (click map)
    let addMode=null;
    document.getElementById('btnAddSub').onclick=()=>{ addMode = addMode==='sub'?null:'sub'; document.getElementById('btnAddSub').classList.toggle('primary', addMode==='sub'); };
    document.getElementById('btnAddGen').onclick=()=>{ addMode = addMode==='gen'?null:'gen'; document.getElementById('btnAddGen').classList.toggle('primary', addMode==='gen'); };
    map.on('click', e=>{ if(!addMode) return; const t=addMode==='sub'?'substation':'generation'; const rec={ __id:crypto.randomUUID(), lat:e.latlng.lat, lng:e.latlng.lng, name:'', type:t, energy_type:t==='substation'?'grid':'generator', reliability:t==='substation'?80:50 }; SITES.push(rec); openSiteEditor(rec); });

    // Add by Lat/Lng
    function addByLL(lat,lng,t,name){ if(!Number.isFinite(lat)||!Number.isFinite(lng)){ alert('Enter numeric Latitude & Longitude'); return; } const rec={ __id:crypto.randomUUID(), lat, lng, name:(name||'').trim(), type:t, energy_type:t==='substation'?'grid':'generator', reliability:t==='substation'?80:50 }; SITES.push(rec); redrawSites(); openSiteEditor(rec); map.panTo([lat,lng]); }
    document.getElementById('btnGeoAddSub').onclick=()=>addByLL(+document.getElementById('geoLat').value, +document.getElementById('geoLng').value,'substation', document.getElementById('geoName').value);
    document.getElementById('btnGeoAddGen').onclick=()=>addByLL(+document.getElementById('geoLat').value, +document.getElementById('geoLng').value,'generation', document.getElementById('geoName').value);

    // Lines (Leaflet.draw)
    let currentDraw=null; const drawOptions={ polyline:{ shapeOptions:{ color:'#111827', weight:3, opacity:.9 } }, polygon:false, rectangle:false, circle:false, circlemarker:false, marker:false };
    document.getElementById('btnDrawLine').onclick=()=>{ if(currentDraw) currentDraw.disable(); currentDraw=new L.Draw.Polyline(map, drawOptions.polyline); currentDraw.enable(); };
    document.getElementById('btnStopDraw').onclick=()=>{ if(currentDraw) currentDraw.disable(); currentDraw=null; };
    map.on(L.Draw.Event.CREATED, e=>{ if(e.layerType==='polyline'){ linesLayer.addLayer(e.layer); } });

    // Data I/O
    document.getElementById('btnExport').onclick=()=>{ const fc={ type:'FeatureCollection', features:[] }; SITES.forEach(s=>{ fc.features.push({ type:'Feature', geometry:{ type:'Point', coordinates:[s.lng,s.lat] }, properties:{ name:s.name, type:s.type, energy_type:s.energy_type, reliability:s.reliability, mw:s.mw, kv:s.kv, status:s.status, notes:s.notes, zone:classify(s) } }); }); linesLayer.eachLayer(l=>{ const coords=l.getLatLngs().map(ll=>[ll.lng,ll.lat]); fc.features.push({ type:'Feature', geometry:{ type:'LineString', coordinates:coords }, properties:{ type:'transmission_line' } }); }); downloadText('rnt_osm_digitized.geojson', JSON.stringify(fc,null,2)); };

    document.getElementById('geojsonFile').addEventListener('change', async ev=>{ const f=ev.target.files?.[0]; if(!f) return; const text=await f.text(); try{ const gj=JSON.parse(text); loadGeoJSON(gj); } catch(e){ alert('Invalid GeoJSON'); console.error(e); } });
    function loadGeoJSON(gj){ SITES.length=0; sitesLayer.clearLayers(); linesLayer.clearLayers(); const feats=gj.type==='FeatureCollection'?(gj.features||[]):Array.isArray(gj)?gj:[]; const pts=[]; feats.forEach(ft=>{ const g=ft.geometry||{}, p=ft.properties||{}; const kind=(p.type||p.kind||'').toLowerCase(); if(g.type==='Point'){ const [lng,lat]=g.coordinates; const rec={ __id:crypto.randomUUID(), lat, lng, name:p.name||'', type:(kind==='plant'?'generation':(kind||'substation')), energy_type:p.energy_type||(kind==='generation'?'generator':'grid'), reliability:+(p.reliability||0), mw:p.mw||'', kv:p.kv||'', status:p.status||'', notes:p.notes||'' }; SITES.push(rec); pts.push([lat,lng]); } else if(g.type==='LineString'){ const latlngs=(g.coordinates||[]).map(([lng,lat])=>L.latLng(lat,lng)); L.polyline(latlngs, drawOptions.polyline.shapeOptions).addTo(linesLayer); } }); redrawSites(); if(pts.length){ const bb=L.latLngBounds(pts); map.fitBounds(bb.pad(0.2)); } }

    // Basemap controls
    document.getElementById('basemapSel').onchange=e=>setBasemap(e.target.value);
    document.getElementById('btnTestMarker').onclick=()=>{ const c=map.getCenter(); const temp={ __id:crypto.randomUUID(), lat:c.lat, lng:c.lng, name:'Test marker', type:'substation', energy_type:'grid', reliability:80 }; SITES.push(temp); redrawSites(); map.openPopup(popupHtml(temp), [c.lat,c.lng]); };
    document.getElementById('btnFitAngola').onclick=()=>map.fitBounds([[-18.1,11.6],[-4.3,24.1]]);
  </script>
</body>
</html>