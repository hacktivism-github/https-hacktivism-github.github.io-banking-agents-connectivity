<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Mobile Operator's Coverage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- CSV helper -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position: absolute; right: 10px; top: 10px; z-index: 1000;
      background: #fff; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15); font: 13px/1.35 system-ui, sans-serif;
      width: 340px; max-width: calc(100vw - 20px);
    }
    .panel h3 { margin: 0 0 6px; font-size: 14px; }
    .row { margin: 6px 0; display: flex; align-items: center; gap: 8px; }
    .row label { white-space: nowrap; }
    .legend {
      position: absolute; left: 10px; bottom: 10px; z-index: 800;
      background: rgba(255,255,255,.9); padding: 8px 10px; border-radius: 6px;
      font: 12px system-ui, sans-serif;
    }
    .nperf-bar {
      position: absolute; right: 10px; bottom: 10px; z-index: 900;
      display: flex; align-items: center; gap: 12px;
      background: rgba(255,255,255,.92); padding: 8px 10px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.12); font: 12px system-ui, sans-serif;
    }
    .badge {
      background: rgba(255,255,255,.95); border-radius: 6px; padding: 4px 8px;
      border: 1px solid #e4e4e4; font-weight: 600; color:#333;
    }
    .techs { display:flex; align-items:center; gap:8px; }
    .tech {
      display:flex; align-items:center; gap:6px; font-weight:600;
      color:#333; border:1px solid #e4e4e4; background:#fff; padding:3px 6px; border-radius:14px;
    }
    .dot {
      width:14px; height:14px; border-radius:50%;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.12);
    }
    .dot.none { background:#bdbdbd; }
    .dot.g2   { background:#555; }
    .dot.g3   { background:#46c35f; }
    .dot.g4   { background:#ff7f32; }
    .dot.g5   { background:#8e44ad; }
    .sw { display:inline-block; width:12px; height:12px; border-radius:2px; margin-right:6px; vertical-align:-2px; }
    .sw.unitel { background:#6c3fd6; }
    .sw.africell { background:#d94b4b; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; background:#f6f6f6; cursor:pointer; }
    .drop-hint {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,.65); color:#fff; padding:8px 12px; border-radius:6px; display:none;
      pointer-events:none; z-index:1200; font:13px system-ui,sans-serif;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="drop-hint" id="dropHint">Largue um CSV (agentes) aqui…</div>

  <div class="panel">
    <h3>Camadas & Dados</h3>

    <div class="row">
      <label><input type="checkbox" id="chkUnitel"> Unitel 4G (nPerf)</label>
      <label><input type="checkbox" id="chkAfricell"> Africell 4G (nPerf)</label>
    </div>

    <div class="row">
      <label style="min-width:80px;">Opacidade</label>
      <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.6" style="flex:1;">
    </div>

    <hr>

    <div class="row"><strong>CSV de agentes</strong></div>
    <div class="row">
      <input type="file" id="csvFile" accept=".csv" />
      <button class="btn" id="clearPoints">Limpar pontos</button>
    </div>
    <div style="color:#666; font-size:12px; margin-top:-2px;">
      Espera colunas como <em>latitude/longitude/nome</em> (auto-detecção: <em>lat, lon, name, displayName</em> etc.).
    </div>
  </div>

  <div class="nperf-bar" id="nperfBar">
    <div class="badge" id="lastUpdate">Last update — Unitel: –, Africell: –</div>
    <div class="techs">
      <div class="tech"><span class="dot none"></span><span>Sem</span></div>
      <div class="tech"><span class="dot g2"></span><span>2G</span></div>
      <div class="tech"><span class="dot g3"></span><span>3G</span></div>
      <div class="tech"><span class="dot g4"></span><span>4G</span></div>
      <div class="tech"><span class="dot g5"></span><span>5G</span></div>
    </div>
  </div>

  <div class="legend">
    <div><span class="sw unitel"></span>Unitel 4G (nPerf)</div>
    <div><span class="sw africell"></span>Africell 4G (nPerf)</div>
    <div style="margin-top:6px;color:#666;">• Pode arrastar CSV para o mapa</div>
  </div>

  <script>
    const map = L.map('map', { zoomControl: true }).setView([-11.5, 17], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const URL_UNITEL   = "https://app.nperf.com/signal-220836-{z}-{x}-{y}.webp";
    const URL_AFRICELL = "https://app.nperf.com/signal-2019555-{z}-{x}-{y}.webp";

    const LAST_UPDATE_UNITEL   = "09/07/2025 10:37 UTC";
    const LAST_UPDATE_AFRICELL = "09/04/2025 18:53 UTC";

    const initialOpacity = 0.6;

    // --- QUICK FIX: scale last available tiles ---
    const unitelLayer = L.tileLayer(URL_UNITEL, {
      opacity: initialOpacity,
      maxNativeZoom: 9,   // adjust if needed (try 8–10 depending on what loads)
      maxZoom: 18,
      errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAQAAABx7n0/AAAAAElFTkSuQmCC'
    });
    const africellLayer = L.tileLayer(URL_AFRICELL, {
      opacity: initialOpacity,
      maxNativeZoom: 9,
      maxZoom: 18,
      errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAQAAABx7n0/AAAAAElFTkSuQmCC'
    });

    const chkUnitel   = document.getElementById('chkUnitel');
    const chkAfricell = document.getElementById('chkAfricell');
    const opacityCtrl = document.getElementById('opacity');
    const lastUpdateEl = document.getElementById('lastUpdate');

    function refreshLastUpdate() {
      lastUpdateEl.textContent = `Last update — Unitel: ${LAST_UPDATE_UNITEL}, Africell: ${LAST_UPDATE_AFRICELL}`;
    }
    refreshLastUpdate();

    chkUnitel.addEventListener('change', e => {
      if (e.target.checked) map.addLayer(unitelLayer);
      else map.removeLayer(unitelLayer);
    });
    chkAfricell.addEventListener('change', e => {
      if (e.target.checked) map.addLayer(africellLayer);
      else map.removeLayer(africellLayer);
    });
    opacityCtrl.addEventListener('input', e => {
      const v = parseFloat(e.target.value);
      unitelLayer.setOpacity(v);
      africellLayer.setOpacity(v);
    });

    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true });
    map.addLayer(cluster);

    function pickColumn(columns, candidates) {
      const lc = columns.map(c => c.toLowerCase());
      for (const cand of candidates) {
        const i = lc.indexOf(cand.toLowerCase());
        if (i !== -1) return columns[i];
      }
      return null;
    }

    function addCsvPoints(rows) {
      cluster.clearLayers();
      let count = 0;
      const cols = Object.keys(rows[0] || {});
      const latCol  = pickColumn(cols, ['latitude','lat']);
      const lonCol  = pickColumn(cols, ['longitude','lon','lng']);
      const nameCol = pickColumn(cols, ['nome','name','displayName','displayname','title']);
      if (!latCol || !lonCol) { alert('Não encontrei colunas de latitude/longitude.'); return; }

      rows.forEach(r => {
        const lat = parseFloat(String(r[latCol]).replace(',', '.'));
        const lon = parseFloat(String(r[lonCol]).replace(',', '.'));
        if (Number.isFinite(lat) && Number.isFinite(lon)) {
          const title = nameCol ? String(r[nameCol]) : 'Agente';
          const m = L.marker([lat, lon]).bindPopup(`<b>${title}</b><br>${lat.toFixed(5)}, ${lon.toFixed(5)}`);
          cluster.addLayer(m);
          count++;
        }
      });

      if (count) map.fitBounds(cluster.getBounds().pad(0.2));
    }

    function loadCsvFile(file) {
      Papa.parse(file, {
        header: true, skipEmptyLines: true,
        complete: (res) => {
          const rows = res.data;
          if (!rows.length) return alert('CSV vazio.');
          addCsvPoints(rows);
        }
      });
    }

    document.getElementById('csvFile').addEventListener('change', e => {
      const f = e.target.files[0]; if (f) loadCsvFile(f);
    });
    document.getElementById('clearPoints').addEventListener('click', () => cluster.clearLayers());

    const dropHint = document.getElementById('dropHint');
    function showHint(show){ dropHint.style.display = show ? 'block' : 'none'; }
    window.addEventListener('dragover', e => { e.preventDefault(); showHint(true); });
    window.addEventListener('dragleave', e => { showHint(false); });
    window.addEventListener('drop', e => {
      e.preventDefault(); showHint(false);
      const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
      if (!f) return;
      const name = (f.name || '').toLowerCase();
      if (name.endsWith('.csv')) return loadCsvFile(f);
      alert('Formato não suportado aqui. Use CSV.');
    });
  </script>
</body>
</html>

